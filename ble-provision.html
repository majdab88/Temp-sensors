<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TempSensor Device Setup</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
      padding: 24px 16px;
    }

    .container { max-width: 480px; margin: 0 auto; }

    h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 4px; }
    .subtitle { color: #6e6e73; font-size: 0.95rem; margin-bottom: 28px; }

    /* ‚îÄ‚îÄ Compat warning ‚îÄ‚îÄ */
    #compat-warning {
      background: #fff3cd; border: 1px solid #ffc107;
      border-radius: 10px; padding: 14px 16px; margin-bottom: 20px;
      font-size: 0.9rem; display: none;
    }
    #compat-warning strong { display: block; margin-bottom: 4px; }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: #fff; border-radius: 14px; padding: 20px;
      margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .card-title {
      font-size: 0.78rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.06em; color: #6e6e73; margin-bottom: 14px;
    }

    /* ‚îÄ‚îÄ Step badges ‚îÄ‚îÄ */
    .step-badge {
      display: inline-flex; align-items: center; justify-content: center;
      width: 24px; height: 24px; border-radius: 50%;
      background: #e8e8ed; color: #6e6e73;
      font-size: 0.8rem; font-weight: 700; margin-right: 8px; flex-shrink: 0;
      transition: background 0.2s, color 0.2s;
    }
    .step-badge.active { background: #0071e3; color: #fff; }
    .step-badge.done   { background: #34c759; color: #fff; }

    .step-header { display: flex; align-items: center; margin-bottom: 14px; }
    .step-header h2 { font-size: 1rem; font-weight: 600; }

    /* ‚îÄ‚îÄ Device info ‚îÄ‚îÄ */
    #device-info {
      display: none; background: #f0f8ff; border: 1px solid #b3d9ff;
      border-radius: 8px; padding: 10px 14px; font-size: 0.88rem; margin-bottom: 14px;
    }
    #device-info span { font-weight: 600; }

    /* ‚îÄ‚îÄ Form labels / inputs ‚îÄ‚îÄ */
    label {
      display: block; font-size: 0.85rem; font-weight: 500;
      color: #3a3a3c; margin-bottom: 4px; margin-top: 12px;
    }
    label:first-of-type { margin-top: 0; }

    input[type="text"], input[type="password"], input[type="number"] {
      width: 100%; padding: 10px 12px; border: 1px solid #d2d2d7;
      border-radius: 8px; font-size: 0.95rem; background: #fafafa;
      outline: none; transition: border-color 0.15s;
    }
    input:focus { border-color: #0071e3; background: #fff; }

    .password-wrap { position: relative; }
    .password-wrap input { padding-right: 44px; }
    .toggle-pass {
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer;
      font-size: 1rem; color: #6e6e73; padding: 0;
    }

    /* ‚îÄ‚îÄ Network list ‚îÄ‚îÄ */
    .scan-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 10px;
    }
    .scan-header-label { font-size: 0.85rem; font-weight: 500; color: #3a3a3c; }

    .btn-scan {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 5px 12px; border: 1px solid #d2d2d7; border-radius: 20px;
      background: #fff; font-size: 0.82rem; font-weight: 600;
      color: #0071e3; cursor: pointer; transition: background 0.15s;
    }
    .btn-scan:hover { background: #f0f7ff; }
    .btn-scan:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-scan.spinning .scan-icon { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .scan-icon { display: inline-block; font-style: normal; }

    .network-list {
      border: 1px solid #d2d2d7; border-radius: 10px; overflow: hidden;
      margin-bottom: 2px;
    }

    .network-item {
      display: flex; align-items: center; gap: 12px;
      padding: 11px 14px; cursor: pointer;
      border-bottom: 1px solid #f2f2f7;
      transition: background 0.1s;
      user-select: none;
    }
    .network-item:last-child { border-bottom: none; }
    .network-item:hover { background: #f5f5f7; }
    .network-item.selected { background: #e8f0fe; }

    .network-radio {
      width: 18px; height: 18px; border-radius: 50%;
      border: 2px solid #d2d2d7; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      transition: border-color 0.15s;
    }
    .network-item.selected .network-radio { border-color: #0071e3; }
    .network-radio-dot {
      width: 8px; height: 8px; border-radius: 50%; background: #0071e3;
      opacity: 0; transition: opacity 0.15s;
    }
    .network-item.selected .network-radio-dot { opacity: 1; }

    .network-ssid { flex: 1; font-size: 0.95rem; font-weight: 500; }

    .signal-bars {
      display: flex; align-items: flex-end; gap: 2px; flex-shrink: 0;
    }
    .signal-bar {
      width: 4px; border-radius: 2px 2px 0 0; background: #d2d2d7;
    }
    .signal-bar.h1 { height: 6px; }
    .signal-bar.h2 { height: 10px; }
    .signal-bar.h3 { height: 14px; }
    .signal-bar.h4 { height: 18px; }
    .signal-bar.active { background: #0071e3; }
    .network-item.selected .signal-bar.active { background: #0071e3; }

    .lock-icon { font-size: 0.75rem; color: #6e6e73; flex-shrink: 0; }

    .network-manual {
      margin-top: 8px; font-size: 0.82rem; color: #0071e3;
      cursor: pointer; display: inline-block; padding: 2px 0;
    }
    .network-manual:hover { text-decoration: underline; }

    .scan-placeholder {
      padding: 20px; text-align: center;
      color: #6e6e73; font-size: 0.88rem;
    }
    .scan-spinner {
      display: inline-block; width: 24px; height: 24px;
      border: 3px solid #e8e8ed; border-top-color: #0071e3;
      border-radius: 50%; animation: spin 0.8s linear infinite;
      margin-bottom: 8px;
    }

    /* Manual SSID entry (shown when "Enter manually" is clicked or no scan) */
    #manual-ssid-wrap { margin-top: 10px; display: none; }

    /* ‚îÄ‚îÄ Details / collapsible ‚îÄ‚îÄ */
    details { margin-top: 14px; }
    details summary {
      cursor: pointer; font-size: 0.88rem; font-weight: 500; color: #0071e3;
      list-style: none; display: flex; align-items: center; gap: 4px;
      user-select: none;
    }
    details summary::before {
      content: "‚ñ∂"; font-size: 0.7rem; transition: transform 0.2s;
    }
    details[open] summary::before { transform: rotate(90deg); }
    .details-body { margin-top: 10px; }

    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-2 label:first-of-type { margin-top: 0; }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
      display: block; width: 100%; padding: 12px; border: none;
      border-radius: 10px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: opacity 0.15s, transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .btn-primary   { background: #0071e3; color: #fff; }
    .btn-success   { background: #34c759; color: #fff; }
    .btn-danger    { background: #ff3b30; color: #fff; }
    .btn-secondary { background: #e8e8ed; color: #1d1d1f; }

    /* ‚îÄ‚îÄ Status pill ‚îÄ‚îÄ */
    .status-row { display: flex; align-items: center; gap: 10px; margin-top: 14px; }
    .status-pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 5px 12px; border-radius: 20px; font-size: 0.82rem; font-weight: 600;
    }
    .status-pill.idle       { background: #e8e8ed; color: #6e6e73; }
    .status-pill.connecting { background: #fff3cd; color: #856404; }
    .status-pill.connected  { background: #d4edda; color: #155724; }
    .status-pill.failed     { background: #f8d7da; color: #721c24; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
    .dot.pulse { animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* ‚îÄ‚îÄ Log ‚îÄ‚îÄ */
    #log {
      background: #1c1c1e; color: #d1d1d6; border-radius: 10px;
      padding: 14px; font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 0.78rem; line-height: 1.6; height: 160px;
      overflow-y: auto; margin-top: 14px;
    }
    .log-ts  { color: #8e8e93; margin-right: 6px; }
    .log-ok  { color: #30d158; }
    .log-err { color: #ff453a; }
    .log-inf { color: #64d2ff; }

    /* ‚îÄ‚îÄ Success ‚îÄ‚îÄ */
    #success-screen {
      display: none; text-align: center; padding: 32px 20px;
    }
    .success-icon { font-size: 4rem; margin-bottom: 12px; }
    #success-screen h2 { font-size: 1.4rem; margin-bottom: 8px; }
    #success-screen p  { color: #6e6e73; margin-bottom: 24px; font-size: 0.95rem; }
  </style>
</head>
<body>
<div class="container">

  <h1>Device Setup</h1>
  <p class="subtitle">Connect your TempSensor master to WiFi and the cloud.</p>

  <div id="compat-warning">
    <strong>‚ö†Ô∏è Web Bluetooth not supported</strong>
    This page requires <strong>Chrome or Edge on Android, Windows, or macOS</strong>.
    Safari and Firefox do not support Web Bluetooth.
    For iOS use the React Native app instead.
  </div>

  <!-- ‚îÄ‚îÄ STEP 1: Connect ‚îÄ‚îÄ -->
  <div class="card" id="card-connect">
    <div class="step-header">
      <span class="step-badge active" id="badge-1">1</span>
      <h2>Find Your Device</h2>
    </div>

    <div id="device-info">
      Connected to <span id="device-name">‚Äî</span>
    </div>

    <button class="btn btn-primary" id="btn-connect" onclick="connect()">
      Scan for Devices
    </button>
    <button class="btn btn-danger" id="btn-disconnect" onclick="disconnect()"
            style="margin-top:10px; display:none;">
      Disconnect
    </button>
  </div>

  <!-- ‚îÄ‚îÄ STEP 2: WiFi Network ‚îÄ‚îÄ -->
  <div class="card" id="card-wifi" style="opacity:0.45; pointer-events:none;">
    <div class="step-header">
      <span class="step-badge" id="badge-2">2</span>
      <h2>WiFi Network</h2>
    </div>

    <!-- Network scan controls -->
    <div class="scan-header">
      <span class="scan-header-label">Select your network</span>
      <button class="btn-scan" id="btn-scan" onclick="requestScan()" disabled>
        <span class="scan-icon" id="scan-icon">‚ü≥</span> Refresh
      </button>
    </div>

    <!-- Network list populated by JS -->
    <div class="network-list" id="network-list">
      <div class="scan-placeholder" id="scan-placeholder">
        Connect to a device first.
      </div>
    </div>

    <span class="network-manual" id="manual-toggle" onclick="toggleManual()">
      Ôºã Enter network name manually
    </span>

    <!-- Manual SSID entry (hidden by default) -->
    <div id="manual-ssid-wrap">
      <label for="ssid">Network name (SSID)</label>
      <input type="text" id="ssid" placeholder="My Hidden Network" autocomplete="off"
             oninput="onManualSsidInput()">
    </div>

    <!-- Password field (shown when a secured network is selected) -->
    <div id="wifi-pass-wrap" style="display:none; margin-top:14px;">
      <label for="wifi-pass">Password</label>
      <div class="password-wrap">
        <input type="password" id="wifi-pass" placeholder="WiFi password"
               autocomplete="current-password">
        <button class="toggle-pass" onclick="togglePass('wifi-pass', this)" tabindex="-1">üëÅ</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ STEP 3: Cloud / MQTT ‚îÄ‚îÄ -->
  <div class="card" id="card-cloud" style="opacity:0.45; pointer-events:none;">
    <div class="step-header">
      <span class="step-badge" id="badge-3">3</span>
      <h2>Cloud Config</h2>
    </div>

    <p style="font-size:0.85rem; color:#6e6e73; margin-bottom:12px;">
      Enter your MQTT broker details. Leave blank to skip cloud setup
      and provision WiFi only (useful for local-only testing).
    </p>

    <details id="cloud-details">
      <summary>MQTT broker credentials (optional)</summary>
      <div class="details-body">
        <label for="mqtt-host">Broker hostname or IP</label>
        <input type="text" id="mqtt-host" placeholder="mqtt.example.com" autocomplete="off">

        <div class="row-2" style="margin-top:12px;">
          <div>
            <label for="mqtt-port">Port</label>
            <input type="number" id="mqtt-port" value="8883" min="1" max="65535">
          </div>
          <div>
            <label for="mqtt-user">Username</label>
            <input type="text" id="mqtt-user" placeholder="device MAC" autocomplete="off">
          </div>
        </div>

        <label for="mqtt-pass">API key / password</label>
        <div class="password-wrap">
          <input type="password" id="mqtt-pass" placeholder="API key from cloud" autocomplete="off">
          <button class="toggle-pass" onclick="togglePass('mqtt-pass', this)" tabindex="-1">üëÅ</button>
        </div>
      </div>
    </details>

    <button class="btn btn-success" id="btn-provision" onclick="provision()"
            style="margin-top:16px;" disabled>
      Provision Device
    </button>

    <div class="status-row">
      <div class="status-pill idle" id="status-pill">
        <div class="dot"></div>
        <span id="status-text">Idle</span>
      </div>
    </div>

    <div id="log"></div>
  </div>

  <!-- ‚îÄ‚îÄ Success ‚îÄ‚îÄ -->
  <div class="card" id="success-screen">
    <div class="success-icon">‚úÖ</div>
    <h2>Device Ready!</h2>
    <p id="success-msg">Your TempSensor master is connected.</p>
    <button class="btn btn-secondary" onclick="resetUI()">Set Up Another Device</button>
  </div>

</div><!-- /container -->

<script>
  // ‚îÄ‚îÄ GATT UUIDs ‚Äî must match firmware ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const SERVICE_UUID    = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
  const CHAR_WIFI       = 'beb5483e-36e1-4688-b7f5-ea07361b26a8'; // write: {ssid,pass}
  const CHAR_CLOUD      = '1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e'; // write: {host,port,user,pass}
  const CHAR_STATUS     = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify: {state,detail}
  const CHAR_NETWORKS   = 'd5913036-2d8a-41ee-85b9-4e361aa5c8a3'; // write any byte = scan trigger
                                                                   // notify: {networks:[{ssid,rssi,enc}]}

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let bleDevice   = null;
  let gattServer  = null;
  let charWifi    = null;
  let charCloud   = null;
  let charStatus  = null;
  let charNetworks = null;        // null if firmware doesn't expose it yet

  let selectedSsid     = null;   // SSID chosen from list
  let selectedOpenNet  = false;  // true if selected network has no password
  let scanInProgress   = false;

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', () => {
    if (!navigator.bluetooth) {
      document.getElementById('compat-warning').style.display = 'block';
      document.getElementById('btn-connect').disabled = true;
    }
  });

  // ‚îÄ‚îÄ BLE Connect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function connect() {
    log('Scanning for TempMaster devices...', 'inf');
    setConnectBusy(true);
    try {
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'TempMaster-' }],
        optionalServices: [SERVICE_UUID]
      });
      bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
      log(`Found: ${bleDevice.name}`, 'inf');

      gattServer = await bleDevice.gatt.connect();
      log('GATT connected', 'inf');

      const service = await gattServer.getPrimaryService(SERVICE_UUID);
      charWifi   = await service.getCharacteristic(CHAR_WIFI);
      charCloud  = await service.getCharacteristic(CHAR_CLOUD);
      charStatus = await service.getCharacteristic(CHAR_STATUS);

      // PROV_NETWORKS is optional ‚Äî firmware may not have it yet
      try {
        charNetworks = await service.getCharacteristic(CHAR_NETWORKS);
        await charNetworks.startNotifications();
        charNetworks.addEventListener('characteristicvaluechanged', onNetworksNotify);
        log('WiFi scan characteristic found', 'ok');
      } catch {
        charNetworks = null;
        log('WiFi scan not supported by firmware ‚Äî enter SSID manually', 'inf');
      }

      await charStatus.startNotifications();
      charStatus.addEventListener('characteristicvaluechanged', onStatusNotify);

      log('Ready to provision', 'ok');
      onConnected();
    } catch (err) {
      log(`Connection failed: ${err.message}`, 'err');
      setConnectBusy(false);
    }
  }

  function onConnected() {
    document.getElementById('device-name').textContent = bleDevice.name;
    document.getElementById('device-info').style.display = 'block';
    document.getElementById('btn-connect').style.display = 'none';
    document.getElementById('btn-disconnect').style.display = 'block';

    setBadgeDone(1);
    unlockCard('card-wifi', 2);
    unlockCard('card-cloud', 3);
    document.getElementById('btn-provision').disabled = false;

    if (charNetworks) {
      document.getElementById('btn-scan').disabled = false;
      requestScan();        // auto-scan on connect
    } else {
      // No scan characteristic ‚Äî show manual entry immediately
      showManualEntry();
      document.getElementById('btn-scan').disabled = true;
      document.getElementById('scan-placeholder').innerHTML =
        'WiFi scan not available in this firmware version.';
    }
  }

  function onDisconnected() {
    log('Device disconnected', 'err');
    charWifi = charCloud = charStatus = charNetworks = null;
    selectedSsid = null;
    setStatus('idle');
    setConnectBusy(false);
    document.getElementById('btn-connect').style.display = 'block';
    document.getElementById('btn-disconnect').style.display = 'none';
    document.getElementById('device-info').style.display = 'none';
    lockCard('card-wifi'); lockCard('card-cloud');
    document.getElementById('btn-provision').disabled = true;
    document.getElementById('btn-scan').disabled = true;
    resetBadge(1); resetBadge(2); resetBadge(3);
    document.getElementById('badge-1').classList.add('active');
    clearNetworkList();
  }

  async function disconnect() {
    if (gattServer && gattServer.connected) gattServer.disconnect();
  }

  // ‚îÄ‚îÄ WiFi Scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function requestScan() {
    if (!charNetworks || scanInProgress) return;
    scanInProgress = true;
    setScanSpinner(true);
    showScanningPlaceholder();
    log('Requesting WiFi scan...', 'inf');
    try {
      // Write any single byte to trigger a scan on the firmware side
      await charNetworks.writeValueWithResponse(new Uint8Array([0x01]));
      // Results arrive via CHAR_NETWORKS notification (onNetworksNotify)
    } catch (err) {
      log(`Scan request failed: ${err.message}`, 'err');
      scanInProgress = false;
      setScanSpinner(false);
      showManualEntry();
    }
  }

  function onNetworksNotify(event) {
    scanInProgress = false;
    setScanSpinner(false);

    const raw = new TextDecoder().decode(event.target.value);
    log(`Received network list`, 'ok');

    let data;
    try { data = JSON.parse(raw); }
    catch { log('Could not parse network list JSON', 'err'); showManualEntry(); return; }

    const networks = data.networks || [];
    if (networks.length === 0) {
      showNoNetworksPlaceholder();
      return;
    }

    renderNetworkList(networks);
  }

  function renderNetworkList(networks) {
    const list = document.getElementById('network-list');
    list.innerHTML = '';

    // Sort by signal strength descending
    networks.sort((a, b) => b.rssi - a.rssi);

    networks.forEach(net => {
      const bars  = rssiToBars(net.rssi);
      const open  = net.enc === 0;
      const item  = document.createElement('div');
      item.className = 'network-item';
      item.dataset.ssid = net.ssid;
      item.dataset.open = open ? '1' : '0';

      item.innerHTML = `
        <div class="network-radio"><div class="network-radio-dot"></div></div>
        <span class="network-ssid">${escapeHtml(net.ssid)}</span>
        <div class="signal-bars">
          <div class="signal-bar h1${bars >= 1 ? ' active' : ''}"></div>
          <div class="signal-bar h2${bars >= 2 ? ' active' : ''}"></div>
          <div class="signal-bar h3${bars >= 3 ? ' active' : ''}"></div>
          <div class="signal-bar h4${bars >= 4 ? ' active' : ''}"></div>
        </div>
        <span class="lock-icon">${open ? 'üîì' : 'üîí'}</span>`;

      item.addEventListener('click', () => selectNetwork(item, net.ssid, open));
      list.appendChild(item);
    });

    log(`Found ${networks.length} network(s)`, 'ok');
  }

  function selectNetwork(item, ssid, isOpen) {
    // Deselect all
    document.querySelectorAll('.network-item').forEach(el => el.classList.remove('selected'));
    item.classList.add('selected');

    selectedSsid    = ssid;
    selectedOpenNet = isOpen;

    // Clear manual input
    document.getElementById('ssid').value = '';
    document.getElementById('manual-ssid-wrap').style.display = 'none';
    document.getElementById('manual-toggle').textContent = 'Ôºã Enter network name manually';

    // Show / hide password field
    document.getElementById('wifi-pass-wrap').style.display = isOpen ? 'none' : 'block';
    if (!isOpen) document.getElementById('wifi-pass').focus();
  }

  function rssiToBars(rssi) {
    if (rssi >= -50) return 4;
    if (rssi >= -60) return 3;
    if (rssi >= -70) return 2;
    return 1;
  }

  // ‚îÄ‚îÄ Manual SSID entry ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let manualOpen = false;

  function toggleManual() {
    manualOpen = !manualOpen;
    const wrap   = document.getElementById('manual-ssid-wrap');
    const toggle = document.getElementById('manual-toggle');
    if (manualOpen) {
      wrap.style.display = 'block';
      toggle.textContent = 'Ôºç Cancel manual entry';
      document.getElementById('ssid').focus();
      // Deselect any list item
      document.querySelectorAll('.network-item').forEach(el => el.classList.remove('selected'));
      selectedSsid = null;
      document.getElementById('wifi-pass-wrap').style.display = 'block';
    } else {
      wrap.style.display = 'none';
      toggle.textContent = 'Ôºã Enter network name manually';
      document.getElementById('ssid').value = '';
      document.getElementById('wifi-pass-wrap').style.display = selectedSsid ? 'block' : 'none';
    }
  }

  function showManualEntry() {
    document.getElementById('network-list').innerHTML = '';
    document.getElementById('manual-ssid-wrap').style.display = 'block';
    document.getElementById('manual-toggle').style.display = 'none';
    document.getElementById('wifi-pass-wrap').style.display = 'block';
  }

  function onManualSsidInput() {
    selectedSsid = null;   // manual entry overrides list selection
    document.querySelectorAll('.network-item').forEach(el => el.classList.remove('selected'));
  }

  // ‚îÄ‚îÄ Provision ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function provision() {
    // Resolve SSID from either list selection or manual input
    const manualSsid = document.getElementById('ssid').value.trim();
    const ssid = selectedSsid || manualSsid;
    if (!ssid) { log('Select a network or enter an SSID first', 'err'); return; }

    const wifiPass = selectedOpenNet ? '' : document.getElementById('wifi-pass').value;

    document.getElementById('btn-provision').disabled = true;
    setStatus('connecting');
    log(`Sending credentials for "${ssid}"...`, 'inf');

    try {
      // 1. WiFi credentials
      await writeChar(charWifi, JSON.stringify({ ssid, pass: wifiPass }));
      log('WiFi credentials written', 'ok');

      // 2. Cloud credentials (optional)
      const mqttHost = document.getElementById('mqtt-host').value.trim();
      if (mqttHost) {
        log('Sending cloud credentials...', 'inf');
        await writeChar(charCloud, JSON.stringify({
          host: mqttHost,
          port: parseInt(document.getElementById('mqtt-port').value) || 8883,
          user: document.getElementById('mqtt-user').value.trim(),
          pass: document.getElementById('mqtt-pass').value
        }));
        log('Cloud credentials written', 'ok');
      } else {
        log('No MQTT host entered ‚Äî skipping cloud config', 'inf');
      }

      log('Waiting for device to connect...', 'inf');
    } catch (err) {
      log(`Provisioning error: ${err.message}`, 'err');
      setStatus('failed');
      document.getElementById('btn-provision').disabled = false;
    }
  }

  function onStatusNotify(event) {
    const raw = new TextDecoder().decode(event.target.value);
    log(`Device: ${raw}`, 'inf');

    let status;
    try { status = JSON.parse(raw); }
    catch { log('Could not parse status JSON', 'err'); return; }

    setStatus(status.state);

    if (status.state === 'connected') {
      setBadgeDone(2); setBadgeDone(3);
      log('Provisioning complete!', 'ok');
      setTimeout(showSuccess, 800);
    } else if (status.state === 'failed') {
      log(`Failed: ${status.detail || 'unknown reason'}`, 'err');
      document.getElementById('btn-provision').disabled = false;
    }
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function writeChar(char, jsonString) {
    const encoded = new TextEncoder().encode(jsonString);
    const CHUNK = 512;
    for (let i = 0; i < encoded.length; i += CHUNK) {
      await char.writeValueWithResponse(encoded.slice(i, i + CHUNK));
    }
  }

  function setStatus(state) {
    const pill = document.getElementById('status-pill');
    const text = document.getElementById('status-text');
    const dot  = pill.querySelector('.dot');
    pill.className = `status-pill ${state}`;
    dot.className  = `dot${state === 'connecting' ? ' pulse' : ''}`;
    const labels = { idle:'Idle', connecting:'Connecting‚Ä¶', connected:'Connected', failed:'Failed' };
    text.textContent = labels[state] || state;
  }

  function log(msg, type = '') {
    const el  = document.getElementById('log');
    const ts  = new Date().toLocaleTimeString();
    const cls = type === 'ok' ? 'log-ok' : type === 'err' ? 'log-err' : 'log-inf';
    const pfx = type === 'ok' ? '‚úì' : type === 'err' ? '‚úó' : '‚Üí';
    el.innerHTML += `<div><span class="log-ts">${ts}</span><span class="${cls}">${pfx} ${escapeHtml(msg)}</span></div>`;
    el.scrollTop = el.scrollHeight;
  }

  function escapeHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function setConnectBusy(busy) {
    const btn = document.getElementById('btn-connect');
    btn.disabled = busy;
    btn.textContent = busy ? 'Connecting‚Ä¶' : 'Scan for Devices';
  }

  function setScanSpinner(on) {
    const btn  = document.getElementById('btn-scan');
    const icon = document.getElementById('scan-icon');
    btn.classList.toggle('spinning', on);
    btn.disabled = on;
    icon.textContent = on ? '‚ü≥' : '‚ü≥';
  }

  function showScanningPlaceholder() {
    document.getElementById('network-list').innerHTML =
      `<div class="scan-placeholder"><div class="scan-spinner"></div><br>Scanning for networks‚Ä¶</div>`;
  }

  function showNoNetworksPlaceholder() {
    document.getElementById('network-list').innerHTML =
      `<div class="scan-placeholder">No networks found.<br>Try refreshing or enter the name manually.</div>`;
    showManualEntry();
  }

  function clearNetworkList() {
    document.getElementById('network-list').innerHTML =
      `<div class="scan-placeholder" id="scan-placeholder">Connect to a device first.</div>`;
    document.getElementById('wifi-pass-wrap').style.display = 'none';
    document.getElementById('manual-ssid-wrap').style.display = 'none';
    document.getElementById('manual-toggle').style.display = '';
    document.getElementById('manual-toggle').textContent = 'Ôºã Enter network name manually';
    manualOpen = false;
    selectedSsid = null;
    selectedOpenNet = false;
  }

  function unlockCard(id, stepNum) {
    const card = document.getElementById(id);
    card.style.opacity = '1';
    card.style.pointerEvents = 'auto';
    document.getElementById(`badge-${stepNum}`).classList.add('active');
  }

  function lockCard(id) {
    const card = document.getElementById(id);
    card.style.opacity = '0.45';
    card.style.pointerEvents = 'none';
  }

  function setBadgeDone(n) {
    const b = document.getElementById(`badge-${n}`);
    b.className = 'step-badge done';
    b.textContent = '‚úì';
  }

  function resetBadge(n) {
    const b = document.getElementById(`badge-${n}`);
    b.className = `step-badge${n === 1 ? ' active' : ''}`;
    b.textContent = n;
  }

  function togglePass(inputId, btn) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
    btn.textContent = input.type === 'password' ? 'üëÅ' : 'üôà';
  }

  function showSuccess() {
    const hasMqtt = document.getElementById('mqtt-host').value.trim() !== '';
    document.getElementById('success-msg').textContent = hasMqtt
      ? 'Your device is connected to WiFi and the cloud. It will appear in the dashboard shortly.'
      : 'Your device is connected to WiFi. Cloud credentials were not set ‚Äî you can provision again to add them.';
    document.getElementById('card-connect').style.display = 'none';
    document.getElementById('card-wifi').style.display    = 'none';
    document.getElementById('card-cloud').style.display   = 'none';
    document.getElementById('success-screen').style.display = 'block';
  }

  function resetUI() {
    disconnect();
    ['card-connect','card-wifi','card-cloud'].forEach(id =>
      document.getElementById(id).style.display = '');
    document.getElementById('success-screen').style.display = 'none';
    document.getElementById('log').innerHTML = '';
    document.getElementById('ssid').value = '';
    document.getElementById('wifi-pass').value = '';
    setStatus('idle');
    document.getElementById('btn-connect').style.display  = 'block';
    document.getElementById('btn-disconnect').style.display = 'none';
    document.getElementById('device-info').style.display  = 'none';
    lockCard('card-wifi'); lockCard('card-cloud');
    resetBadge(1); resetBadge(2); resetBadge(3);
    document.getElementById('badge-1').classList.add('active');
    document.getElementById('btn-provision').disabled = true;
    document.getElementById('btn-scan').disabled = true;
    clearNetworkList();
  }
</script>
</body>
</html>
