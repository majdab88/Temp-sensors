# ============================================================
# Eclipse Mosquitto 2 — Temp-sensors Cloud Broker
# ============================================================
#
# Password file setup (run once on the VPS):
#
#   # Create the file and add the backend service account:
#   docker run --rm -it -v $(pwd)/mosquitto:/mosquitto/config \
#     eclipse-mosquitto:2 \
#     mosquitto_passwd -c /mosquitto/config/passwd backend
#
#   # Add a hub device (replace AABBCCDDEEFF with the hub's MAC, no colons):
#   docker run --rm -it -v $(pwd)/mosquitto:/mosquitto/config \
#     eclipse-mosquitto:2 \
#     mosquitto_passwd /mosquitto/config/passwd AABBCCDDEEFF
#
#   # Each hub device's username = its MAC address (uppercase, no colons).
#   # The API key generated by the backend is stored as the password.
#   # The backend calls mosquitto_passwd programmatically after device registration.
#
# After editing the passwd file, reload without restart:
#   docker compose kill -s SIGHUP mosquitto
# ============================================================

# ---- General -----------------------------------------------
per_listener_settings false   # password_file and acl_file apply to all listeners

persistence true
persistence_location /mosquitto/data/

# ---- Logging -----------------------------------------------
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information

# ---- Authentication & ACL (global) -------------------------
allow_anonymous false
password_file /mosquitto/config/passwd
acl_file      /mosquitto/config/acl

# ---- Listener 1: Internal plaintext (backend only) ---------
# Not mapped to the host in docker-compose.yml — internal Docker network only.
listener 1883

# ---- Listener 2: External TLS (ESP32 hubs) -----------------
# Domain: majdtemp32.duckdns.org (matches the .env DOMAIN value).
listener 8883
certfile /etc/letsencrypt/live/majdtemp32.duckdns.org/fullchain.pem
keyfile  /etc/letsencrypt/live/majdtemp32.duckdns.org/privkey.pem
tls_version tlsv1.2

# Require clients to present a valid username + password; reject anonymous.
# (Certificate-based client auth is not required — password auth is sufficient
#  combined with TLS transport encryption.)
require_certificate false
